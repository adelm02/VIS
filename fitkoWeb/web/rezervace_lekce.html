<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rezervace lekce - FITKO</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .header { background: #2d2d2d; color: white; padding: 15px 30px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .credits { background: white; padding: 8px 15px; border-radius: 20px; color: #2d2d2d; font-weight: 600; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .filters { padding: 20px 30px; display: flex; gap: 20px; border-bottom: 1px solid #e0e0e0; }
        .filter-group { flex: 1; }
        .filter-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #333; }
        .filter-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .lessons-table { width: 100%; border-collapse: collapse; }
        .lessons-table thead { background: #f9f9f9; }
        .lessons-table th { padding: 15px 20px; text-align: left; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; }
        .lessons-table td { padding: 15px 20px; border-bottom: 1px solid #f0f0f0; }
        .lessons-table tr:hover { background: #f9f9f9; }
        .capacity { color: #666; }
        .capacity.full { color: #f44336; font-weight: 600; }
        .btn-reserve { background: #000; color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 14px; }
        .btn-reserve:hover { background: #333; }
        .btn-reserve:disabled { background: #ccc; cursor: not-allowed; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%; position: relative; }
        .modal-close { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
        .modal-title { font-size: 20px; font-weight: 600; margin-bottom: 20px; }
        .modal-section { margin-bottom: 25px; }
        .modal-section h3 { font-size: 16px; font-weight: 600; margin-bottom: 10px; color: #333; }
        .detail-row { display: flex; justify-content: space-between; padding: 8px 0; color: #666; }
        .detail-label { font-weight: 500; }
        .detail-value { font-weight: 600; color: #000; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; }
        .btn-cancel { background: white; border: 1px solid #ddd; padding: 10px 24px; border-radius: 4px; cursor: pointer; font-weight: 600; }
        .btn-confirm { background: #000; color: white; border: none; padding: 10px 24px; border-radius: 4px; cursor: pointer; font-weight: 600; }
        .message { margin: 20px 30px; padding: 12px; border-radius: 4px; display: none; }
        .message.success { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
        .message.error { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }
        .loading { text-align: center; padding: 40px; color: #666; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Rezervace lekce</h1>
        <div class="credits">游눱 Credits: <span id="userCredits">-</span></div>
    </div>

    <div class="filters">
        <div class="filter-group">
            <label>Day</label>
            <select id="filterDay">
                <option value="">All Days</option>
                <option value="Monday">Monday</option>
                <option value="Tuesday">Tuesday</option>
                <option value="Wednesday">Wednesday</option>
                <option value="Thursday">Thursday</option>
                <option value="Friday">Friday</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Trainer</label>
            <select id="filterTrainer">
                <option value="">All Trainers</option>
            </select>
        </div>
    </div>

    <div id="message" class="message"></div>

    <div id="loading" class="loading" style="display:none;">Loading...</div>

    <table class="lessons-table">
        <thead>
        <tr>
            <th>Title</th>
            <th>Day</th>
            <th>Time</th>
            <th>Trainer</th>
            <th>Capacity</th>
            <th>Price</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody id="lessonsTable">
        </tbody>
    </table>
</div>

<div id="confirmModal" class="modal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <h2 class="modal-title">Confirm Reservation</h2>
        <p style="color: #666; margin-bottom: 20px;">Please review the lesson details before confirming your reservation.</p>

        <div class="modal-section">
            <h3>Lesson Details</h3>
            <div class="detail-row"><span class="detail-label">Title:</span><span class="detail-value" id="modalTitle"></span></div>
            <div class="detail-row"><span class="detail-label">Trainer:</span><span class="detail-value" id="modalTrainer"></span></div>
            <div class="detail-row"><span class="detail-label">Day:</span><span class="detail-value" id="modalDay"></span></div>
            <div class="detail-row"><span class="detail-label">Time:</span><span class="detail-value" id="modalTime"></span></div>
            <div class="detail-row"><span class="detail-label">Capacity:</span><span class="detail-value" id="modalCapacity"></span></div>
        </div>

        <div class="modal-section">
            <h3>Payment Summary</h3>
            <div class="detail-row"><span class="detail-label">Price:</span><span class="detail-value"><span id="modalPrice"></span> credits</span></div>
            <div class="detail-row"><span class="detail-label">Current credits:</span><span class="detail-value"><span id="modalCurrentCredits"></span> credits</span></div>
            <div class="detail-row" style="border-top: 1px solid #e0e0e0; padding-top: 10px; margin-top: 10px;">
                <span class="detail-label">Credits after purchase:</span><span class="detail-value"><span id="modalAfterCredits"></span> credits</span>
            </div>
        </div>

        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeModal()">Cancel</button>
            <button class="btn-confirm" onclick="confirmReservation()">Confirm</button>
        </div>
    </div>
</div>

<script>
    const API_URL = 'http://localhost:8080/api';
    const CUSTOMER_ID = 1; // Anna Nov치kov치

    let currentUserCredits = 0;
    let selectedLesson = null;
    let lessons = [];

    async function loadCustomer() {
        try {
            const res = await fetch(`${API_URL}/customer?id=${CUSTOMER_ID}`);
            const customer = await res.json();
            currentUserCredits = customer.credit;
            document.getElementById('userCredits').textContent = currentUserCredits;
        } catch (e) {
            console.error('Failed to load customer:', e);
        }
    }

    async function loadLessons() {
        document.getElementById('loading').style.display = 'block';
        try {
            const res = await fetch(`${API_URL}/lessons`);
            lessons = await res.json();
            renderLessons();
            loadTrainers();
        } catch (e) {
            console.error('Failed to load lessons:', e);
            showMessage('Failed to load lessons', 'error');
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    function renderLessons() {
        const tbody = document.getElementById('lessonsTable');
        const filterDay = document.getElementById('filterDay').value;
        const filterTrainer = document.getElementById('filterTrainer').value;

        let filtered = lessons.filter(lesson => {
            if (filterDay && lesson.day !== filterDay) return false;
            if (filterTrainer && lesson.trainer !== filterTrainer) return false;
            return true;
        });

        tbody.innerHTML = filtered.map(lesson => {
            const isFull = lesson.loggedIn >= lesson.capacity;
            return `
                    <tr>
                        <td>${lesson.title}</td>
                        <td>${lesson.day}</td>
                        <td>${lesson.time}</td>
                        <td>${lesson.trainer}</td>
                        <td class="capacity ${isFull ? 'full' : ''}">${lesson.loggedIn}/${lesson.capacity} ${isFull ? 'FULL' : ''}</td>
                        <td>${lesson.price} credits</td>
                        <td>
                            <button class="btn-reserve"
                                    onclick="openReservationModal(${lesson.id})"
                                    ${isFull ? 'disabled' : ''}>
                                Reserve
                            </button>
                        </td>
                    </tr>
                `;
        }).join('');
    }

    function loadTrainers() {
        const trainers = [...new Set(lessons.map(l => l.trainer))];
        const select = document.getElementById('filterTrainer');
        select.innerHTML = '<option value="">All Trainers</option>';
        trainers.forEach(trainer => {
            const option = document.createElement('option');
            option.value = trainer;
            option.textContent = trainer;
            select.appendChild(option);
        });
    }

    function openReservationModal(lessonId) {
        selectedLesson = lessons.find(l => l.id === lessonId);
        if (!selectedLesson) return;

        document.getElementById('modalTitle').textContent = selectedLesson.title;
        document.getElementById('modalTrainer').textContent = selectedLesson.trainer;
        document.getElementById('modalDay').textContent = selectedLesson.day;
        document.getElementById('modalTime').textContent = selectedLesson.time;
        document.getElementById('modalCapacity').textContent = `${selectedLesson.loggedIn}/${selectedLesson.capacity}`;
        document.getElementById('modalPrice').textContent = selectedLesson.price;
        document.getElementById('modalCurrentCredits').textContent = currentUserCredits;
        document.getElementById('modalAfterCredits').textContent = currentUserCredits - selectedLesson.price;

        document.getElementById('confirmModal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('confirmModal').classList.remove('active');
        selectedLesson = null;
    }

    function showMessage(text, type) {
        const msg = document.getElementById('message');
        msg.textContent = text;
        msg.className = `message ${type}`;
        msg.style.display = 'block';
        setTimeout(() => msg.style.display = 'none', 5000);
    }

    async function confirmReservation() {
        if (!selectedLesson) return;

        if (currentUserCredits < selectedLesson.price) {
            showMessage('Nedostatek kreditu', 'error');
            closeModal();
            return;
        }

        try {
            const res = await fetch(`${API_URL}/reservations`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    customerId: CUSTOMER_ID,
                    lessonId: selectedLesson.id,
                    date: new Date().toISOString().split('T')[0]
                })
            });

            const data = await res.json();

            if (data.success) {
                currentUserCredits = data.newCredits;
                document.getElementById('userCredits').textContent = currentUserCredits;
                showMessage(`Rezervace vytvo콏ena: ${selectedLesson.title}`, 'success');
                await loadLessons();
            } else {
                showMessage(data.error || 'Chyba p콏i vytv치콏en칤 rezervace', 'error');
            }
        } catch (e) {
            console.error('Failed to create reservation:', e);
            showMessage('Chyba p콏i vytv치콏en칤 rezervace', 'error');
        } finally {
            closeModal();
        }
    }

    document.getElementById('filterDay').addEventListener('change', renderLessons);
    document.getElementById('filterTrainer').addEventListener('change', renderLessons);

    // Initialize
    loadCustomer();
    loadLessons();
</script>
</body>
</html>